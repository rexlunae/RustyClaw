name: Incident Tracker

on:
  issues:
    types: [opened, closed, labeled, unlabeled]

permissions:
  issues: write

jobs:
  track-incident:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'incident')
    steps:
      - name: Record incident opened
        if: github.event.action == 'opened' || (github.event.action == 'labeled' && github.event.label.name == 'incident')
        run: |
          echo "::notice::Incident opened: #${{ github.event.issue.number }} - ${{ github.event.issue.title }}"
          echo "Created at: ${{ github.event.issue.created_at }}"

          # Extract severity from labels
          SEVERITY="unknown"
          if echo '${{ toJSON(github.event.issue.labels.*.name) }}' | grep -q "severity:critical"; then
            SEVERITY="critical"
          elif echo '${{ toJSON(github.event.issue.labels.*.name) }}' | grep -q "severity:high"; then
            SEVERITY="high"
          elif echo '${{ toJSON(github.event.issue.labels.*.name) }}' | grep -q "severity:medium"; then
            SEVERITY="medium"
          elif echo '${{ toJSON(github.event.issue.labels.*.name) }}' | grep -q "severity:low"; then
            SEVERITY="low"
          fi

          gh issue comment ${{ github.event.issue.number }} --body "ðŸš¨ **Incident Tracking Started**

          - **Incident Number**: #${{ github.event.issue.number }}
          - **Severity**: ${SEVERITY}
          - **Opened At**: ${{ github.event.issue.created_at }}
          - **Status**: ðŸ”´ Active

          The incident will be tracked for MTTR (Mean Time to Recovery) metrics. Please update this issue with investigation progress and resolution details.

          **Checklist**:
          - [ ] Incident triaged and severity assigned
          - [ ] Root cause identified
          - [ ] Fix implemented
          - [ ] Fix deployed to production
          - [ ] Service restored and monitoring confirms stability
          - [ ] Postmortem completed

          *This comment was automatically generated by the [Incident Tracker workflow](https://github.com/${{ github.repository }}/actions/workflows/incident-tracker.yml).*"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Calculate MTTR and record resolution
        if: github.event.action == 'closed'
        run: |
          # Calculate time to recovery
          CREATED=$(date -d "${{ github.event.issue.created_at }}" +%s)
          CLOSED=$(date -d "${{ github.event.issue.closed_at }}" +%s)
          MTTR_SECONDS=$((CLOSED - CREATED))
          MTTR_MINUTES=$((MTTR_SECONDS / 60))
          MTTR_HOURS=$(echo "scale=1; $MTTR_SECONDS / 3600" | bc)
          MTTR_DAYS=$(echo "scale=1; $MTTR_SECONDS / 86400" | bc)

          # Determine human-readable format
          if (( MTTR_SECONDS < 3600 )); then
            MTTR_HUMAN="${MTTR_MINUTES}m"
          elif (( MTTR_SECONDS < 86400 )); then
            MTTR_HUMAN="${MTTR_HOURS}h"
          else
            MTTR_HUMAN="${MTTR_DAYS}d"
          fi

          # Determine performance level
          if (( $(echo "$MTTR_HOURS <= 1" | bc -l) )); then
            LEVEL="Elite âœ…"
            COLOR="ðŸŸ¢"
          elif (( $(echo "$MTTR_HOURS <= 24" | bc -l) )); then
            LEVEL="High ðŸŸ¢"
            COLOR="ðŸŸ¢"
          elif (( $(echo "$MTTR_HOURS <= 168" | bc -l) )); then
            LEVEL="Medium ðŸŸ¡"
            COLOR="ðŸŸ¡"
          else
            LEVEL="Low ðŸ”´"
            COLOR="ðŸ”´"
          fi

          # Extract severity
          SEVERITY="unknown"
          if echo '${{ toJSON(github.event.issue.labels.*.name) }}' | grep -q "severity:critical"; then
            SEVERITY="critical"
          elif echo '${{ toJSON(github.event.issue.labels.*.name) }}' | grep -q "severity:high"; then
            SEVERITY="high"
          elif echo '${{ toJSON(github.event.issue.labels.*.name) }}' | grep -q "severity:medium"; then
            SEVERITY="medium"
          elif echo '${{ toJSON(github.event.issue.labels.*.name) }}' | grep -q "severity:low"; then
            SEVERITY="low"
          fi

          echo "::notice::Incident #${{ github.event.issue.number }} resolved - MTTR: ${MTTR_HUMAN} (${LEVEL})"

          # Post resolution comment
          gh issue comment ${{ github.event.issue.number }} --body "${COLOR} **Incident Resolved**

          ## Resolution Metrics

          - **Time to Recovery (MTTR)**: ${MTTR_HUMAN} (${MTTR_HOURS} hours)
          - **Performance Level**: ${LEVEL}
          - **Severity**: ${SEVERITY}
          - **Opened**: ${{ github.event.issue.created_at }}
          - **Closed**: ${{ github.event.issue.closed_at }}

          ## DORA Benchmarks

          | Level | MTTR Target |
          |-------|-------------|
          | Elite âœ… | <1 hour |
          | High ðŸŸ¢ | <1 day |
          | Medium ðŸŸ¡ | 1-7 days |
          | Low ðŸ”´ | >7 days |

          ---

          *This incident contributed to the project's [DORA metrics](https://github.com/${{ github.repository }}/actions/workflows/dora-metrics.yml). Next DORA calculation will include this data.*"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Suggest postmortem if high severity
        if: github.event.action == 'closed' && (contains(github.event.issue.labels.*.name, 'severity:critical') || contains(github.event.issue.labels.*.name, 'severity:high'))
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "ðŸ“ **Postmortem Recommended**

          This was a **critical** or **high-severity** incident. Consider creating a postmortem document covering:

          1. **What Happened**: Timeline of events
          2. **Root Cause**: Technical explanation of the failure
          3. **Impact**: User-facing consequences and metrics
          4. **Resolution**: How the incident was resolved
          5. **Prevention**: Action items to prevent recurrence
          6. **Lessons Learned**: Key takeaways for the team

          Create the postmortem in `docs/postmortems/incident-${{ github.event.issue.number }}.md` and link it to this issue."
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Update incident metrics summary
        if: github.event.action == 'closed'
        run: |
          echo "Incident #${{ github.event.issue.number }} closed" >> $GITHUB_STEP_SUMMARY
          echo "This incident will be included in the next DORA metrics calculation (runs daily at 00:00 UTC)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View current metrics: https://github.com/${{ github.repository }}/actions/workflows/dora-metrics.yml" >> $GITHUB_STEP_SUMMARY
